"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDevice = require("appium-ios-device");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _appUtils = require("./app-utils");

var _iosFsHelpers = require("./ios-fs-helpers");

const APPLICATION_INSTALLED_NOTIFICATION = 'com.apple.mobile.application_installed';
const INSTALLATION_STAGING_DIR = 'PublicStaging';
const APPLICATION_NOTIFICATION_TIMEOUT_MS = 30 * 1000;
const IOS_DEPLOY_TIMEOUT_MS = 4 * 60 * 1000;
const IOS_DEPLOY = 'ios-deploy';
const APP_INSTALL_STRATEGY = Object.freeze({
  SERIAL: 'serial',
  PARALLEL: 'parallel',
  IOS_DEPLOY
});

class IOSDeploy {
  constructor(udid) {
    this.udid = udid;
  }

  async remove(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      await service.uninstallApplication(bundleid);
    } finally {
      service.close();
    }
  }

  async removeApp(bundleId) {
    await this.remove(bundleId);
  }

  async install(app, timeout, strategy = null) {
    if (strategy && !_lodash.default.values(APP_INSTALL_STRATEGY).includes(_lodash.default.toLower(strategy))) {
      throw new Error(`App installation strategy '${strategy}' is unknown. ` + `Only the following strategies are supported: ${_lodash.default.values(APP_INSTALL_STRATEGY)}`);
    }

    _logger.default.debug(`Using '${strategy !== null && strategy !== void 0 ? strategy : APP_INSTALL_STRATEGY.SERIAL}' app deployment strategy. ` + `You could change it by providing another value to the 'appInstallStrategy' capability`);

    const installWithIosDeploy = async () => {
      try {
        await _appiumSupport.fs.which(IOS_DEPLOY);
      } catch (err) {
        throw new Error(`'${IOS_DEPLOY}' utility has not been found in PATH. Is it installed?`);
      }

      try {
        await (0, _teen_process.exec)(IOS_DEPLOY, ['--id', this.udid, '--bundle', app], {
          timeout: timeout !== null && timeout !== void 0 ? timeout : IOS_DEPLOY_TIMEOUT_MS
        });
      } catch (err) {
        throw new Error(err.stderr || err.stdout || err.message);
      }
    };

    const timer = new _appiumSupport.timing.Timer().start();

    if (_lodash.default.toLower(strategy) === APP_INSTALL_STRATEGY.IOS_DEPLOY) {
      await installWithIosDeploy();
    } else {
      const afcService = await _appiumIosDevice.services.startAfcService(this.udid);

      try {
        const bundleId = await (0, _appUtils.extractBundleId)(app);

        const bundlePathOnPhone = _path.default.join(INSTALLATION_STAGING_DIR, bundleId);

        await (0, _iosFsHelpers.pushFolder)(afcService, app, bundlePathOnPhone, {
          timeoutMs: timeout,
          enableParallelPush: _lodash.default.toLower(strategy) === APP_INSTALL_STRATEGY.PARALLEL
        });
        await this.installOrUpgradeApplication(bundlePathOnPhone, await this.isAppInstalled(bundleId));
      } catch (err) {
        _logger.default.warn(`Error installing app '${app}': ${err.message}`);

        if (err instanceof _bluebird.default.TimeoutError) {
          _logger.default.warn(`Consider increasing the value of 'appPushTimeout' capability`);
        }

        _logger.default.warn(`Falling back to '${IOS_DEPLOY}' usage`);

        try {
          await installWithIosDeploy();
        } catch (err1) {
          throw new Error(`Could not install '${app}':\n` + `  - ${err.message}\n` + `  - ${err1.message}`);
        }
      } finally {
        afcService.close();
      }
    }

    _logger.default.info(`App installation succeeded after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
  }

  async installOrUpgradeApplication(bundlePathOnPhone, isUpgrade = false) {
    const notificationService = await _appiumIosDevice.services.startNotificationProxyService(this.udid);
    const installationService = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    const appInstalledNotification = new _bluebird.default(resolve => {
      notificationService.observeNotification(APPLICATION_INSTALLED_NOTIFICATION, {
        notification: resolve
      });
    });
    const clientOptions = {
      PackageType: 'Developer'
    };

    try {
      if (isUpgrade) {
        _logger.default.debug(`An upgrade of the existing application is going to be performed`);

        await installationService.upgradeApplication(bundlePathOnPhone, clientOptions);
      } else {
        _logger.default.debug(`A new application installation is going to be performed`);

        await installationService.installApplication(bundlePathOnPhone, clientOptions);
      }

      try {
        await appInstalledNotification.timeout(APPLICATION_NOTIFICATION_TIMEOUT_MS, `Could not get the application installed notification within ` + `${APPLICATION_NOTIFICATION_TIMEOUT_MS}ms but we will continue`);
      } catch (e) {
        _logger.default.warn(`Failed to receive the notification. Error: ${e.message}`);
      }
    } finally {
      installationService.close();
      notificationService.close();
    }
  }

  async installApp(app, timeout) {
    await this.install(app, timeout);
  }

  async isAppInstalled(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.lookupApplications({
        bundleIds: bundleid
      });
      return !!applications[bundleid];
    } finally {
      service.close();
    }
  }

  async getUserInstalledBundleIdsByBundleName(bundleName) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.listApplications({
        applicationType: 'User'
      });
      return _lodash.default.reduce(applications, (acc, {
        CFBundleName
      }, key) => {
        if (CFBundleName === bundleName) {
          acc.push(key);
        }

        return acc;
      }, []);
    } finally {
      service.close();
    }
  }

  async getPlatformVersion() {
    return await _appiumIosDevice.utilities.getOSVersion(this.udid);
  }

}

var _default = IOSDeploy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZGVwbG95LmpzIl0sIm5hbWVzIjpbIkFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04iLCJJTlNUQUxMQVRJT05fU1RBR0lOR19ESVIiLCJBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVF9NUyIsIklPU19ERVBMT1lfVElNRU9VVF9NUyIsIklPU19ERVBMT1kiLCJBUFBfSU5TVEFMTF9TVFJBVEVHWSIsIk9iamVjdCIsImZyZWV6ZSIsIlNFUklBTCIsIlBBUkFMTEVMIiwiSU9TRGVwbG95IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwicmVtb3ZlIiwiYnVuZGxlaWQiLCJzZXJ2aWNlIiwic2VydmljZXMiLCJzdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSIsInVuaW5zdGFsbEFwcGxpY2F0aW9uIiwiY2xvc2UiLCJyZW1vdmVBcHAiLCJidW5kbGVJZCIsImluc3RhbGwiLCJhcHAiLCJ0aW1lb3V0Iiwic3RyYXRlZ3kiLCJfIiwidmFsdWVzIiwiaW5jbHVkZXMiLCJ0b0xvd2VyIiwiRXJyb3IiLCJsb2ciLCJkZWJ1ZyIsImluc3RhbGxXaXRoSW9zRGVwbG95IiwiZnMiLCJ3aGljaCIsImVyciIsInN0ZGVyciIsInN0ZG91dCIsIm1lc3NhZ2UiLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJhZmNTZXJ2aWNlIiwic3RhcnRBZmNTZXJ2aWNlIiwiYnVuZGxlUGF0aE9uUGhvbmUiLCJwYXRoIiwiam9pbiIsInRpbWVvdXRNcyIsImVuYWJsZVBhcmFsbGVsUHVzaCIsImluc3RhbGxPclVwZ3JhZGVBcHBsaWNhdGlvbiIsImlzQXBwSW5zdGFsbGVkIiwid2FybiIsIkIiLCJUaW1lb3V0RXJyb3IiLCJlcnIxIiwiaW5mbyIsImdldER1cmF0aW9uIiwiYXNNaWxsaVNlY29uZHMiLCJ0b0ZpeGVkIiwiaXNVcGdyYWRlIiwibm90aWZpY2F0aW9uU2VydmljZSIsInN0YXJ0Tm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlIiwiaW5zdGFsbGF0aW9uU2VydmljZSIsImFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbiIsInJlc29sdmUiLCJvYnNlcnZlTm90aWZpY2F0aW9uIiwibm90aWZpY2F0aW9uIiwiY2xpZW50T3B0aW9ucyIsIlBhY2thZ2VUeXBlIiwidXBncmFkZUFwcGxpY2F0aW9uIiwiaW5zdGFsbEFwcGxpY2F0aW9uIiwiZSIsImluc3RhbGxBcHAiLCJhcHBsaWNhdGlvbnMiLCJsb29rdXBBcHBsaWNhdGlvbnMiLCJidW5kbGVJZHMiLCJnZXRVc2VySW5zdGFsbGVkQnVuZGxlSWRzQnlCdW5kbGVOYW1lIiwiYnVuZGxlTmFtZSIsImxpc3RBcHBsaWNhdGlvbnMiLCJhcHBsaWNhdGlvblR5cGUiLCJyZWR1Y2UiLCJhY2MiLCJDRkJ1bmRsZU5hbWUiLCJrZXkiLCJwdXNoIiwiZ2V0UGxhdGZvcm1WZXJzaW9uIiwidXRpbGl0aWVzIiwiZ2V0T1NWZXJzaW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGtDQUFrQyxHQUFHLHdDQUEzQztBQUNBLE1BQU1DLHdCQUF3QixHQUFHLGVBQWpDO0FBQ0EsTUFBTUMsbUNBQW1DLEdBQUcsS0FBSyxJQUFqRDtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLElBQUksRUFBSixHQUFTLElBQXZDO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLFlBQW5CO0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0FBQ3pDQyxFQUFBQSxNQUFNLEVBQUUsUUFEaUM7QUFFekNDLEVBQUFBLFFBQVEsRUFBRSxVQUYrQjtBQUd6Q0wsRUFBQUE7QUFIeUMsQ0FBZCxDQUE3Qjs7QUFPQSxNQUFNTSxTQUFOLENBQWdCO0FBRWRDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBRixFQUFRO0FBQ2pCLFNBQUtBLElBQUwsR0FBWUEsSUFBWjtBQUNEOztBQUVXLFFBQU5DLE1BQU0sQ0FB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QUFPLENBQUMsQ0FBQzZELFlBQVksQ0FBQzdELFFBQUQsQ0FBckI7QUFDRCxLQUhELFNBR1U7QUFDUkMsTUFBQUEsT0FBTyxDQUFDSSxLQUFSO0FBQ0Q7QUFDRjs7QUFRMEMsUUFBckMyRCxxQ0FBcUMsQ0FBRUMsVUFBRixFQUFjO0FBQ3ZELFVBQU1oRSxPQUFPLEdBQUcsTUFBTUMsMEJBQVNDLDZCQUFULENBQXVDLEtBQUtMLElBQTVDLENBQXRCOztBQUNBLFFBQUk7QUFDRixZQUFNK0QsWUFBWSxHQUFHLE1BQU01RCxPQUFPLENBQUNpRSxnQkFBUixDQUF5QjtBQUFDQyxRQUFBQSxlQUFlLEVBQUU7QUFBbEIsT0FBekIsQ0FBM0I7QUFDQSxhQUFPdkQsZ0JBQUV3RCxNQUFGLENBQVNQLFlBQVQsRUFBdUIsQ0FBQ1EsR0FBRCxFQUFNO0FBQUNDLFFBQUFBO0FBQUQsT0FBTixFQUFzQkMsR0FBdEIsS0FBOEI7QUFDMUQsWUFBSUQsWUFBWSxLQUFLTCxVQUFyQixFQUFpQztBQUMvQkksVUFBQUEsR0FBRyxDQUFDRyxJQUFKLENBQVNELEdBQVQ7QUFDRDs7QUFDRCxlQUFPRixHQUFQO0FBQ0QsT0FMTSxFQUtKLEVBTEksQ0FBUDtBQU1ELEtBUkQsU0FRVTtBQUNScEUsTUFBQUEsT0FBTyxDQUFDSSxLQUFSO0FBQ0Q7QUFDRjs7QUFFdUIsUUFBbEJvRSxrQkFBa0IsR0FBSTtBQUMxQixXQUFPLE1BQU1DLDJCQUFVQyxZQUFWLENBQXVCLEtBQUs3RSxJQUE1QixDQUFiO0FBQ0Q7O0FBM0phOztlQThKREYsUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzLCB0aW1pbmcgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHNlcnZpY2VzLCB1dGlsaXRpZXMgfSBmcm9tICdhcHBpdW0taW9zLWRldmljZSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IGV4dHJhY3RCdW5kbGVJZCB9IGZyb20gJy4vYXBwLXV0aWxzJztcbmltcG9ydCB7IHB1c2hGb2xkZXIgfSBmcm9tICcuL2lvcy1mcy1oZWxwZXJzJztcblxuY29uc3QgQVBQTElDQVRJT05fSU5TVEFMTEVEX05PVElGSUNBVElPTiA9ICdjb20uYXBwbGUubW9iaWxlLmFwcGxpY2F0aW9uX2luc3RhbGxlZCc7XG5jb25zdCBJTlNUQUxMQVRJT05fU1RBR0lOR19ESVIgPSAnUHVibGljU3RhZ2luZyc7XG5jb25zdCBBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVF9NUyA9IDMwICogMTAwMDtcbmNvbnN0IElPU19ERVBMT1lfVElNRU9VVF9NUyA9IDQgKiA2MCAqIDEwMDA7XG5jb25zdCBJT1NfREVQTE9ZID0gJ2lvcy1kZXBsb3knO1xuY29uc3QgQVBQX0lOU1RBTExfU1RSQVRFR1kgPSBPYmplY3QuZnJlZXplKHtcbiAgU0VSSUFMOiAnc2VyaWFsJyxcbiAgUEFSQUxMRUw6ICdwYXJhbGxlbCcsXG4gIElPU19ERVBMT1ksXG59KTtcblxuXG5jbGFzcyBJT1NEZXBsb3kge1xuXG4gIGNvbnN0cnVjdG9yICh1ZGlkKSB7XG4gICAgdGhpcy51ZGlkID0gdWRpZDtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZSAoYnVuZGxlaWQpIHtcbiAgICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgc2VydmljZS51bmluc3RhbGxBcHBsaWNhdGlvbihidW5kbGVpZCk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyByZW1vdmVBcHAgKGJ1bmRsZUlkKSB7XG4gICAgYXdhaXQgdGhpcy5yZW1vdmUoYnVuZGxlSWQpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbCAoYXBwLCB0aW1lb3V0LCBzdHJhdGVneSA9IG51bGwpIHtcbiAgICBpZiAoc3RyYXRlZ3kgJiYgIV8udmFsdWVzKEFQUF9JTlNUQUxMX1NUUkFURUdZKS5pbmNsdWRlcyhfLnRvTG93ZXIoc3RyYXRlZ3kpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBcHAgaW5zdGFsbGF0aW9uIHN0cmF0ZWd5ICcke3N0cmF0ZWd5fScgaXMgdW5rbm93bi4gYCArXG4gICAgICAgIGBPbmx5IHRoZSBmb2xsb3dpbmcgc3RyYXRlZ2llcyBhcmUgc3VwcG9ydGVkOiAke18udmFsdWVzKEFQUF9JTlNUQUxMX1NUUkFURUdZKX1gKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBVc2luZyAnJHtzdHJhdGVneSA/PyBBUFBfSU5TVEFMTF9TVFJBVEVHWS5TRVJJQUx9JyBhcHAgZGVwbG95bWVudCBzdHJhdGVneS4gYCArXG4gICAgICBgWW91IGNvdWxkIGNoYW5nZSBpdCBieSBwcm92aWRpbmcgYW5vdGhlciB2YWx1ZSB0byB0aGUgJ2FwcEluc3RhbGxTdHJhdGVneScgY2FwYWJpbGl0eWApO1xuXG4gICAgY29uc3QgaW5zdGFsbFdpdGhJb3NEZXBsb3kgPSBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBmcy53aGljaChJT1NfREVQTE9ZKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke0lPU19ERVBMT1l9JyB1dGlsaXR5IGhhcyBub3QgYmVlbiBmb3VuZCBpbiBQQVRILiBJcyBpdCBpbnN0YWxsZWQ/YCk7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBleGVjKElPU19ERVBMT1ksIFtcbiAgICAgICAgICAnLS1pZCcsIHRoaXMudWRpZCxcbiAgICAgICAgICAnLS1idW5kbGUnLCBhcHAsXG4gICAgICAgIF0sIHt0aW1lb3V0OiB0aW1lb3V0ID8/IElPU19ERVBMT1lfVElNRU9VVF9NU30pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIuc3RkZXJyIHx8IGVyci5zdGRvdXQgfHwgZXJyLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICAgIGlmIChfLnRvTG93ZXIoc3RyYXRlZ3kpID09PSBBUFBfSU5TVEFMTF9TVFJBVEVHWS5JT1NfREVQTE9ZKSB7XG4gICAgICBhd2FpdCBpbnN0YWxsV2l0aElvc0RlcGxveSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBhZmNTZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRBZmNTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBidW5kbGVJZCA9IGF3YWl0IGV4dHJhY3RCdW5kbGVJZChhcHApO1xuICAgICAgICBjb25zdCBidW5kbGVQYXRoT25QaG9uZSA9IHBhdGguam9pbihJTlNUQUxMQVRJT05fU1RBR0lOR19ESVIsIGJ1bmRsZUlkKTtcbiAgICAgICAgYXdhaXQgcHVzaEZvbGRlcihhZmNTZXJ2aWNlLCBhcHAsIGJ1bmRsZVBhdGhPblBob25lLCB7XG4gICAgICAgICAgdGltZW91dE1zOiB0aW1lb3V0LFxuICAgICAgICAgIGVuYWJsZVBhcmFsbGVsUHVzaDogXy50b0xvd2VyKHN0cmF0ZWd5KSA9PT0gQVBQX0lOU1RBTExfU1RSQVRFR1kuUEFSQUxMRUwsXG4gICAgICAgIH0pO1xuICAgICAgICBhd2FpdCB0aGlzLmluc3RhbGxPclVwZ3JhZGVBcHBsaWNhdGlvbihidW5kbGVQYXRoT25QaG9uZSwgYXdhaXQgdGhpcy5pc0FwcEluc3RhbGxlZChidW5kbGVJZCkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy53YXJuKGBFcnJvciBpbnN0YWxsaW5nIGFwcCAnJHthcHB9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEIuVGltZW91dEVycm9yKSB7XG4gICAgICAgICAgbG9nLndhcm4oYENvbnNpZGVyIGluY3JlYXNpbmcgdGhlIHZhbHVlIG9mICdhcHBQdXNoVGltZW91dCcgY2FwYWJpbGl0eWApO1xuICAgICAgICB9XG4gICAgICAgIGxvZy53YXJuKGBGYWxsaW5nIGJhY2sgdG8gJyR7SU9TX0RFUExPWX0nIHVzYWdlYCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgaW5zdGFsbFdpdGhJb3NEZXBsb3koKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyMSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGluc3RhbGwgJyR7YXBwfSc6XFxuYCArXG4gICAgICAgICAgICBgICAtICR7ZXJyLm1lc3NhZ2V9XFxuYCArXG4gICAgICAgICAgICBgICAtICR7ZXJyMS5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBhZmNTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGxvZy5pbmZvKGBBcHAgaW5zdGFsbGF0aW9uIHN1Y2NlZWRlZCBhZnRlciAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbE9yVXBncmFkZUFwcGxpY2F0aW9uIChidW5kbGVQYXRoT25QaG9uZSwgaXNVcGdyYWRlID0gZmFsc2UpIHtcbiAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnROb3RpZmljYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICBjb25zdCBpbnN0YWxsYXRpb25TZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICBjb25zdCBhcHBJbnN0YWxsZWROb3RpZmljYXRpb24gPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5vYnNlcnZlTm90aWZpY2F0aW9uKEFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04sIHtcbiAgICAgICAgbm90aWZpY2F0aW9uOiByZXNvbHZlXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBjb25zdCBjbGllbnRPcHRpb25zID0ge1BhY2thZ2VUeXBlOiAnRGV2ZWxvcGVyJ307XG4gICAgdHJ5IHtcbiAgICAgIGlmIChpc1VwZ3JhZGUpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBBbiB1cGdyYWRlIG9mIHRoZSBleGlzdGluZyBhcHBsaWNhdGlvbiBpcyBnb2luZyB0byBiZSBwZXJmb3JtZWRgKTtcbiAgICAgICAgYXdhaXQgaW5zdGFsbGF0aW9uU2VydmljZS51cGdyYWRlQXBwbGljYXRpb24oYnVuZGxlUGF0aE9uUGhvbmUsIGNsaWVudE9wdGlvbnMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKGBBIG5ldyBhcHBsaWNhdGlvbiBpbnN0YWxsYXRpb24gaXMgZ29pbmcgdG8gYmUgcGVyZm9ybWVkYCk7XG4gICAgICAgIGF3YWl0IGluc3RhbGxhdGlvblNlcnZpY2UuaW5zdGFsbEFwcGxpY2F0aW9uKGJ1bmRsZVBhdGhPblBob25lLCBjbGllbnRPcHRpb25zKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbi50aW1lb3V0KEFQUExJQ0FUSU9OX05PVElGSUNBVElPTl9USU1FT1VUX01TLFxuICAgICAgICAgIGBDb3VsZCBub3QgZ2V0IHRoZSBhcHBsaWNhdGlvbiBpbnN0YWxsZWQgbm90aWZpY2F0aW9uIHdpdGhpbiBgICtcbiAgICAgICAgICBgJHtBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVF9NU31tcyBidXQgd2Ugd2lsbCBjb250aW51ZWApO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgRmFpbGVkIHRvIHJlY2VpdmUgdGhlIG5vdGlmaWNhdGlvbi4gRXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICBpbnN0YWxsYXRpb25TZXJ2aWNlLmNsb3NlKCk7XG4gICAgICBub3RpZmljYXRpb25TZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbEFwcCAoYXBwLCB0aW1lb3V0KSB7XG4gICAgYXdhaXQgdGhpcy5pbnN0YWxsKGFwcCwgdGltZW91dCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGFuIGFwcGxpY2F0aW9uIG9iamVjdCBpZiB0ZXN0IGFwcCBoYXMgJ2J1bmRsZWlkJy5cbiAgICogVGhlIHRhcmdldCBidW5kbGVpZCBjYW4gYmUgVXNlciBhbmQgU3lzdGVtIGFwcHMuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVpZCBUaGUgYnVuZGxlSWQgdG8gZW5zdXJlIGl0IGlzIGluc3RhbGxlZFxuICAgKiBAcmV0dXJuIHtib29sZWFufSBSZXR1cm5zIFRydWUgaWYgdGhlIGJ1bmRsZWlkIGV4aXN0cyBpbiB0aGUgcmVzdWx0IG9mICdsaXN0QXBwbGljYXRpb25zJyBsaWtlOlxuICAgKiB7IFwiY29tLmFwcGxlLlByZWZlcmVuY2VzXCI6e1xuICAgKiAgIFwiVUlSZXF1aXJlZERldmljZUNhcGFiaWxpdGllc1wiOltcImFybTY0XCJdLFxuICAgKiAgIFwiVUlSZXF1aXJlc0Z1bGxTY3JlZW5cIjp0cnVlLFxuICAgKiAgIFwiQ0ZCdW5kbGVJbmZvRGljdGlvbmFyeVZlcnNpb25cIjpcIjYuMFwiLFxuICAgKiAgIFwiRW50aXRsZW1lbnRzXCI6XG4gICAqICAgICB7XCJjb20uYXBwbGUuZnJvbnRib2FyZC5kZWxldGUtYXBwbGljYXRpb24tc25hcHNob3RzXCI6dHJ1ZSwuLlxuICAgKi9cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZWlkKSB7XG4gICAgY29uc3Qgc2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwcGxpY2F0aW9ucyA9IGF3YWl0IHNlcnZpY2UubG9va3VwQXBwbGljYXRpb25zKHsgYnVuZGxlSWRzOiBidW5kbGVpZCB9KTtcbiAgICAgIHJldHVybiAhIWFwcGxpY2F0aW9uc1tidW5kbGVpZF07XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZU5hbWUgVGhlIG5hbWUgb2YgQ0ZCdW5kbGVOYW1lIGluIEluZm8ucGxpc3RcbiAgICpcbiAgICogQHJldHVybnMge0FycmF5PHN0cmluZz59IEEgbGlzdCBvZiBVc2VyIGxldmVsIGFwcHMnIGJ1bmRsZSBpZHMgd2hpY2ggaGFzXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAnQ0ZCdW5kbGVOYW1lJyBhdHRyaWJ1dGUgYXMgJ2J1bmRsZU5hbWUnLlxuICAgKi9cbiAgYXN5bmMgZ2V0VXNlckluc3RhbGxlZEJ1bmRsZUlkc0J5QnVuZGxlTmFtZSAoYnVuZGxlTmFtZSkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBsaWNhdGlvbnMgPSBhd2FpdCBzZXJ2aWNlLmxpc3RBcHBsaWNhdGlvbnMoe2FwcGxpY2F0aW9uVHlwZTogJ1VzZXInfSk7XG4gICAgICByZXR1cm4gXy5yZWR1Y2UoYXBwbGljYXRpb25zLCAoYWNjLCB7Q0ZCdW5kbGVOYW1lfSwga2V5KSA9PiB7XG4gICAgICAgIGlmIChDRkJ1bmRsZU5hbWUgPT09IGJ1bmRsZU5hbWUpIHtcbiAgICAgICAgICBhY2MucHVzaChrZXkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LCBbXSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRQbGF0Zm9ybVZlcnNpb24gKCkge1xuICAgIHJldHVybiBhd2FpdCB1dGlsaXRpZXMuZ2V0T1NWZXJzaW9uKHRoaXMudWRpZCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSU9TRGVwbG95O1xuIl0sImZpbGUiOiJsaWIvaW9zLWRlcGxveS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
